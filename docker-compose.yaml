version: '3.8'

services:
  # Inventory API Service (Go)
  api-inventory:
    build:
      context: ./apps/api-inventory
      dockerfile: Dockerfile
    container_name: autostack-api-inventory
    environment:
      DATA_PATH: ${DATA_PATH:-/app/data/seed}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      PORT: ${INVENTORY_PORT:-8001}
      CLOUDBEES_FM_API_KEY: ${CLOUDBEES_FM_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${INVENTORY_PORT:-8001}:8001"
    volumes:
      - ./data/seed:/app/data/seed:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - autostack-network

  # Valuations API Service (Go)
  api-valuations:
    build:
      context: ./apps/api-valuations
      dockerfile: Dockerfile
    container_name: autostack-api-valuations
    environment:
      DATA_PATH: ${DATA_PATH:-/app/data/seed}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      PORT: ${VALUATIONS_PORT:-8002}
      CLOUDBEES_FM_API_KEY: ${CLOUDBEES_FM_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${VALUATIONS_PORT:-8002}:8002"
    volumes:
      - ./data/seed:/app/data/seed:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - autostack-network

  # Web Application (React + Vite)
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        VITE_ROX_API_KEY: ${CLOUDBEES_FM_API_KEY}
        NGINX_CONFIG: nginx.local.conf
    container_name: autostack-web
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      api-inventory:
        condition: service_healthy
      api-valuations:
        condition: service_healthy
    networks:
      - autostack-network

networks:
  autostack-network:
    driver: bridge
